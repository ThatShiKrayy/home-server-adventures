services:
  traefik:
    container_name: traefik
    command:
    #- --add-host=host.docker.internal:172.17.0.1
    - --accessLog=true
    - --accessLog.filePath=/logs/access.log
    - --accessLog.bufferingSize=100
    - --accessLog.filters.statusCodes=204-299,400-499,500-599
    - --api=true
    - --api.dashboard=true
    - --api.insecure=true
    - --certificatesResolvers.dns-cloudflare.acme.storage=/acme.json
    - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.provider=cloudflare
    - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.resolvers=1.1.1.1:53,1.0.0.1:53
    - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.delayBeforeCheck=90
    - --global.checkNewVersion=true
    - --global.sendAnonymousUsage=true
    - --entrypoints.web.address=:80
    - --entrypoints.websecure.address=:443
    - --entrypoints.traefik.address=:8080
    - --entrypoints.websecure.http.tls=true
    - --entrypoints.web.http.redirections.entrypoint.to=websecure
    - --entrypoints.web.http.redirections.entrypoint.scheme=https
    - --entrypoints.web.http.redirections.entrypoint.permanent=true
    - --entrypoints.websecure.http.tls.options=tls-opts@file
    - --entrypoints.websecure.http.tls.certresolver=dns-cloudflare
    - --entrypoints.websecure.http.tls.domains[0].main=$DOMAINNAME_1
    - --entrypoints.websecure.http.tls.domains[0].sans=*.$DOMAINNAME_1
    - --entrypoints.websecure.http.tls.domains[1].main=$DOMAINNAME_2
    - --entrypoints.websecure.http.tls.domains[1].sans=*.$DOMAINNAME_2
    - --entrypoints.https.forwardedHeaders.trustedIPs=$CLOUDFLARE_IPS,$LOCAL_IPS
    - --log=true
    - --log.filePath=/logs/traefik.log
    - --log.level=INFO
    - --metrics.addinternals
    - --metrics.prometheus=true
    - --metrics.prometheus.buckets=0.1,0.3,1.2,5.0
    - --metrics.prometheus.addEntryPointsLabels=true
    - --metrics.prometheus.addrouterslabels=true
    - --metrics.prometheus.addServicesLabels=true
    - --providers.docker=true
    - --providers.docker.endpoint=tcp://socket-proxy:2375
    - --providers.docker.exposedByDefault=false
    - --providers.docker.network=t3_proxy
    - --providers.file.directory=/rules
    - --providers.file.watch=true
    environment:
    - TZ=$TZ
    - CF_DNS_API_TOKEN_FILE=$CF_DNS_API_TOKEN_FILE
    - DOMAINNAME_1
    image: traefik:latest
    labels:
    - "traefik.enable=true"
    # # HTTP Routers
    - "traefik.http.routers.traefik-rtr.entrypoints=websecure"
    # # Services - API
    - "traefik.http.routers.traefik-rtr.service=api@internal"
    # Middlewares
    - "traefik.http.routers.traefik-rtr.middlewares=chain-no-auth@file"
    networks:
      t3_proxy:
        ipv4_address: 192.168.52.254
      socket_proxy:
      crowdsec:
    ports:
    - target: 80
      published: 80
      protocol: tcp
      mode: host
    - target: 443
      published: 443
      protocol: tcp
      mode: host
    - target: 8080
      published: 8085
      protocol: tcp
      mode: host
    restart: unless-stopped
    security_opt:
    - no-new-privileges:true
    secrets:
    - cf_dns_api_token
    - crowdsec_lapi_key
    volumes:
    - $DOCKERDIR/appdata/traefik/rules/$HOSTNAME:/rules
    - $DOCKERDIR/appdata/traefik/acme/acme.json:/acme.json
    - $DOCKERDIR/logs/$HOSTNAME/traefik:/logs
